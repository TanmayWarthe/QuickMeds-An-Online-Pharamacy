{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}My Profile - QuickMeds{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Header -->
    <div class="profile-header">
        <div class="avatar">
            {% if user.userprofile.profile_image %}
            <img src="{{ user.userprofile.profile_image.url }}" alt="Profile">
            {% else %}
            <i class="fas fa-user"></i>
            {% endif %}
        </div>
        <div>
            <h1>{{ user.get_full_name|default:user.username }}</h1>
            <p><i class="fas fa-envelope"></i> {{ user.email }}</p>
            <p><i class="fas fa-calendar"></i> Member since {{ user.date_joined|date:"F Y" }}</p>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="active" onclick="showTab('info')"><i class="fas fa-user"></i> Info</button>
        <button onclick="showTab('orders')"><i class="fas fa-shopping-bag"></i> Orders {% if orders_count %}({{ orders_count }}){% endif %}</button>
        <button onclick="showTab('addresses')"><i class="fas fa-map-marker-alt"></i> Addresses</button>
        <button onclick="showTab('settings')"><i class="fas fa-cog"></i> Settings</button>
        <form id="logoutForm" method="POST" action="{% url 'logout' %}" style="display: inline; margin-left: auto;">
            {% csrf_token %}
            <button type="submit" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </form>
    </div>
    
    <!-- Info Tab -->
    <div id="info" class="tab-panel active">
        <div class="card">
            <h3><i class="fas fa-user-circle"></i> Personal Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Full Name</span>
                    <span class="info-value">{{ user.get_full_name|default:"Not set" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Email</span>
                    <span class="info-value">{{ user.email }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Phone</span>
                    <span class="info-value">{{ user.userprofile.phone|default:"Not set" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Gender</span>
                    <span class="info-value">
                        {% if user.userprofile.gender == 'M' %}Male
                        {% elif user.userprofile.gender == 'F' %}Female
                        {% elif user.userprofile.gender == 'O' %}Other
                        {% else %}Not set{% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-label">Date of Birth</span>
                    <span class="info-value">{{ user.userprofile.dob|date:"F d, Y"|default:"Not set" }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Member Since</span>
                    <span class="info-value">{{ user.date_joined|date:"F Y" }}</span>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="openEditProfileModal()">
                    <i class="fas fa-edit"></i> Edit Profile
                </button>
            </div>
        </div>
    </div>
    
    <!-- Orders Tab -->
    <div id="orders" class="tab-panel">
        <h2 style="margin-bottom: 20px;"><i class="fas fa-shopping-bag"></i> My Orders</h2>
        {% if orders %}
            {% for order in orders %}
            <div class="order-item">
                <div class="order-header">
                    <div>
                        <strong>Order #{{ order.id }}</strong>
                        <span style="color: #999; margin-left: 12px;">{{ order.created_at|date:"d M Y" }}</span>
                    </div>
                    <span class="badge {% if order.order_status == 'DELIVERED' %}badge-success{% elif order.order_status == 'CANCELLED' %}badge-danger{% else %}badge-warning{% endif %}">
                        {{ order.order_status }}
                    </span>
                </div>
                <div class="order-footer">
                    <div>
                        <p style="margin: 0; color: #666; font-size: 14px;">{{ order.items.count }} item(s)</p>
                        <p class="price">â‚¹{{ order.total_amount|intcomma }}</p>
                    </div>
                    <a href="{% url 'order_detail' order.id %}" class="btn btn-primary">
                        <i class="fas fa-eye"></i> View Details
                    </a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-shopping-bag"></i>
                <p>No orders yet</p>
                <a href="{% url 'product' %}" class="btn btn-primary">Start Shopping</a>
            </div>
        {% endif %}
    </div>
    
    <!-- Addresses Tab -->
    <div id="addresses" class="tab-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
            <h2><i class="fas fa-map-marker-alt"></i> My Addresses</h2>
            <button class="btn btn-primary" onclick="openAddAddressModal()">
                <i class="fas fa-plus"></i> Add Address
            </button>
        </div>
        
        {% if addresses %}
            {% for address in addresses %}
            <div class="address-item">
                {% if address.is_default %}
                <span class="default-badge">DEFAULT</span>
                {% endif %}
                <div style="margin-bottom: 8px;">
                    <i class="fas fa-{% if address.type == 'Home' %}home{% elif address.type == 'Office' %}building{% else %}map-marker{% endif %}" style="color: #667eea; margin-right: 6px;"></i>
                    <strong>{{ address.type }}</strong>
                </div>
                <h4>{{ address.full_name }}</h4>
                <p>{{ address.phone_number }}</p>
                <p>{{ address.street_address }}</p>
                <p>{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                <div class="address-actions">
                    <button class="btn btn-secondary" onclick="openEditAddressModal({{ address.id }}, '{{ address.full_name }}', '{{ address.phone_number }}', '{{ address.type }}', '{{ address.street_address }}', '{{ address.city }}', '{{ address.state }}', '{{ address.postal_code }}', {{ address.is_default|yesno:'true,false' }})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="btn btn-danger" onclick="deleteAddress({{ address.id }})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <i class="fas fa-map-marker-alt"></i>
                <p>No addresses yet</p>
                <button class="btn btn-primary" onclick="openAddAddressModal()">
                    <i class="fas fa-plus"></i> Add Your First Address
                </button>
            </div>
        {% endif %}
    </div>
    
    <!-- Settings Tab -->
    <div id="settings" class="tab-panel">
        <div class="card">
            <h3><i class="fas fa-lock"></i> Change Password</h3>
            <form id="changePasswordForm" style="max-width: 500px;">
                {% csrf_token %}
                <div class="form-group">
                    <label>Current Password</label>
                    <input type="password" class="form-control" placeholder="Enter current password" autocomplete="current-password" name="current_password" required>
                    <span class="form-error"></span>
                </div>
                <div class="form-group">
                    <label>New Password</label>
                    <input type="password" class="form-control" placeholder="Enter new password (min 8 characters)" autocomplete="new-password" name="new_password" required minlength="8">
                    <span class="form-error"></span>
                </div>
                <div class="form-group">
                    <label>Confirm New Password</label>
                    <input type="password" class="form-control" placeholder="Confirm new password" autocomplete="new-password" name="confirm_password" required minlength="8">
                    <span class="form-error"></span>
                </div>
                <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                    <i class="fas fa-key"></i> Update Password
                </button>
            </form>
        </div>
        
        <div class="card" style="border: 2px solid #dc3545;">
            <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
            <p style="color: #666; margin-bottom: 15px;">Once you delete your account, there is no going back. Please be certain.</p>
            <button class="btn btn-danger" onclick="if(confirm('Are you absolutely sure you want to delete your account? This action cannot be undone!')) { alert('Account deletion feature will be implemented by admin.'); }">
                <i class="fas fa-trash-alt"></i> Delete Account
            </button>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-edit"></i> Edit Profile</h3>
            <button class="modal-close" onclick="closeModal('editProfileModal')">&times;</button>
        </div>
        <form id="editProfileForm">
            {% csrf_token %}
            <div class="form-group">
                <label>First Name *</label>
                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Last Name *</label>
                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Phone Number</label>
                <input type="tel" class="form-control" name="phone" value="{{ user.userprofile.phone|default:'' }}" pattern="[0-9]{10}" placeholder="10-digit mobile number">
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Gender</label>
                <select class="form-control" name="gender">
                    <option value="">Select Gender</option>
                    <option value="M" {% if user.userprofile.gender == 'M' %}selected{% endif %}>Male</option>
                    <option value="F" {% if user.userprofile.gender == 'F' %}selected{% endif %}>Female</option>
                    <option value="O" {% if user.userprofile.gender == 'O' %}selected{% endif %}>Other</option>
                </select>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" class="form-control" name="dob" value="{{ user.userprofile.dob|date:'Y-m-d' }}">
                <span class="form-error"></span>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editProfileModal')">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Address Modal -->
<div id="addressModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="addressModalTitle"><i class="fas fa-map-marker-alt"></i> Add Address</h3>
            <button class="modal-close" onclick="closeModal('addressModal')">&times;</button>
        </div>
        <form id="addressForm">
            {% csrf_token %}
            <input type="hidden" name="address_id" id="addressId">
            <div class="form-group">
                <label>Full Name *</label>
                <input type="text" class="form-control" name="full_name" required>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" class="form-control" name="phone_number" pattern="[0-9]{10}" required placeholder="10-digit mobile number">
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Address Type *</label>
                <select class="form-control" name="type" required>
                    <option value="Home">Home</option>
                    <option value="Office">Office</option>
                    <option value="Other">Other</option>
                </select>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Street Address *</label>
                <textarea class="form-control" name="street_address" rows="2" required placeholder="House No., Building Name, Street"></textarea>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>City *</label>
                <input type="text" class="form-control" name="city" required>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>State *</label>
                <input type="text" class="form-control" name="state" required>
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label>Postal Code *</label>
                <input type="text" class="form-control" name="postal_code" pattern="[0-9]{6}" required placeholder="6-digit PIN code">
                <span class="form-error"></span>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" name="is_default" value="true">
                    Set as default address
                </label>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addressModal')">Cancel</button>
                <button type="submit" class="btn btn-primary" id="saveAddressBtn">
                    <i class="fas fa-save"></i> Save Address
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Tab Switching
function showTab(tabName) {
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.querySelectorAll('.tabs button:not(.logout-btn)').forEach(btn => btn.classList.remove('active'));
    
    document.getElementById(tabName).classList.add('active');
    event.target.classList.add('active');
}

// Modal Functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
    document.body.style.overflow = '';
    
    // Clear form
    const form = document.querySelector(`#${modalId} form`);
    if (form) {
        form.reset();
        // Clear error messages
        form.querySelectorAll('.form-group').forEach(group => {
            group.classList.remove('has-error');
            const errorSpan = group.querySelector('.form-error');
            if (errorSpan) errorSpan.textContent = '';
        });
    }
}

// Close modal when clicking outside
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal(this.id);
        }
    });
});

// Edit Profile Functions
function openEditProfileModal() {
    openModal('editProfileModal');
}

document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveProfileBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('{% url "update_profile" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Profile updated successfully!');
            closeModal('editProfileModal');
            location.reload();
        } else {
            // Handle errors
            if (data.errors) {
                Object.keys(data.errors).forEach(field => {
                    const input = this.querySelector(`[name="${field}"]`);
                    if (input) {
                        const formGroup = input.closest('.form-group');
                        formGroup.classList.add('has-error');
                        const errorSpan = formGroup.querySelector('.form-error');
                        errorSpan.textContent = data.errors[field][0];
                    }
                });
            } else {
                alert(data.message || 'Error updating profile');
            }
        }
    } catch (error) {
        alert('Error updating profile: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});

// Address Functions
function openAddAddressModal() {
    document.getElementById('addressModalTitle').innerHTML = '<i class="fas fa-map-marker-alt"></i> Add Address';
    document.getElementById('addressForm').reset();
    document.getElementById('addressId').value = '';
    openModal('addressModal');
}

function openEditAddressModal(id, fullName, phone, type, street, city, state, postal, isDefault) {
    document.getElementById('addressModalTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Address';
    document.getElementById('addressId').value = id;
    
    const form = document.getElementById('addressForm');
    form.querySelector('[name="full_name"]').value = fullName;
    form.querySelector('[name="phone_number"]').value = phone;
    form.querySelector('[name="type"]').value = type;
    form.querySelector('[name="street_address"]').value = street;
    form.querySelector('[name="city"]').value = city;
    form.querySelector('[name="state"]').value = state;
    form.querySelector('[name="postal_code"]').value = postal;
    form.querySelector('[name="is_default"]').checked = isDefault;
    
    openModal('addressModal');
}

document.getElementById('addressForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('saveAddressBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Saving...';
    
    const formData = new FormData(this);
    const addressId = formData.get('address_id');
    
    const url = addressId ? '{% url "update_address" %}' : '{% url "add_address" %}';
    const method = 'POST';
    
    const data = {};
    formData.forEach((value, key) => {
        if (key !== 'csrfmiddlewaretoken' && key !== 'address_id') {
            data[key] = key === 'is_default' ? value === 'true' : value;
        }
    });
    
    if (addressId) {
        data.address_id = addressId;
    }
    
    try {
        const response = await fetch(url, {
            method: method,
            body: JSON.stringify(data),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const result = await response.json();
        
        if (result.success || result.status === 'success') {
            alert(addressId ? 'Address updated successfully!' : 'Address added successfully!');
            closeModal('addressModal');
            location.reload();
        } else {
            alert(result.message || 'Error saving address');
        }
    } catch (error) {
        alert('Error saving address: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});

async function deleteAddress(addressId) {
    if (!confirm('Are you sure you want to delete this address?')) {
        return;
    }
    
    try {
        const response = await fetch('{% url "delete_address" %}', {
            method: 'POST',
            body: JSON.stringify({ address_id: addressId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success || data.status === 'success') {
            alert('Address deleted successfully!');
            location.reload();
        } else {
            alert(data.message || 'Error deleting address');
        }
    } catch (error) {
        alert('Error deleting address: ' + error.message);
    }
}

// Change Password
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const newPassword = formData.get('new_password');
    const confirmPassword = formData.get('confirm_password');
    
    // Clear previous errors
    this.querySelectorAll('.form-group').forEach(group => {
        group.classList.remove('has-error');
        group.querySelector('.form-error').textContent = '';
    });
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        const confirmGroup = this.querySelector('[name="confirm_password"]').closest('.form-group');
        confirmGroup.classList.add('has-error');
        confirmGroup.querySelector('.form-error').textContent = 'Passwords do not match';
        return;
    }
    
    const btn = document.getElementById('changePasswordBtn');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Updating...';
    
    try {
        const response = await fetch('{% url "change_password" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        });
        
        const data = await response.json();
        
        if (data.success || data.status === 'success') {
            alert('Password changed successfully!');
            this.reset();
        } else {
            if (data.errors) {
                Object.keys(data.errors).forEach(field => {
                    const input = this.querySelector(`[name="${field}"]`);
                    if (input) {
                        const formGroup = input.closest('.form-group');
                        formGroup.classList.add('has-error');
                        formGroup.querySelector('.form-error').textContent = data.errors[field][0];
                    }
                });
            } else {
                alert(data.message || 'Error changing password');
            }
        }
    } catch (error) {
        alert('Error changing password: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHtml;
    }
});
</script>
{% endblock %}
