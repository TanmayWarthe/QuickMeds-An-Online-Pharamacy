{% load static %}
<!-- Professional Navbar - Top-Tier Navigation System -->
<nav class="modern-navbar">
    <div class="container-fluid" style="padding: 0 1.5rem;">
        <div class="navbar-content">
            <!-- Mobile: Hamburger Menu -->
            <button class="sidebar-toggle" id="sidebarToggle" type="button" aria-label="Menu">
                <i class="fas fa-bars toggle-icon"></i>
            </button>

            <!-- Left: Brand -->
            <div class="brand-group">
                {% block navbar_brand %}
                <a href="{% url 'home' %}" class="brand-logo">
                    <div class="logo-icon">
                        <img src="{% static 'img/logo.png' %}" alt="QuickMeds">
                    </div>
                    <span class="brand-name">QuickMeds</span>
                </a>
                {% endblock %}
            </div>

            <!-- Center: Main Navigation (Desktop) -->
            <div class="nav-center">
                {% block navbar_center %}
                <nav class="main-nav" aria-label="Main navigation">
                    <a href="{% url 'home' %}" class="nav-link {% if request.path == '/' %}active{% endif %}">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                    <a href="{% url 'product' %}" class="nav-link {% if 'product' in request.path %}active{% endif %}">
                        <i class="fas fa-pills"></i>
                        <span>Medicines</span>
                    </a>
                    <a href="{% url 'contact' %}" class="nav-link {% if 'contact' in request.path %}active{% endif %}">
                        <i class="fas fa-envelope"></i>
                        <span>Contact</span>
                    </a>
                </nav>
                {% endblock %}
            </div>

            <!-- Right: Actions -->
            <div class="nav-right">
                {% block navbar_extra_left %}{% endblock %}

                <!-- Inline Expanding Search with Suggestions -->
                <div class="nav-search-wrapper" id="navSearchWrapper">
                    <button class="nav-search-btn" id="searchToggle" type="button" aria-label="Search">
                        <i class="fas fa-search"></i>
                    </button>
                    <form action="/search/" method="GET" class="nav-search-form" id="navSearchForm">
                        <input type="search" name="q" class="nav-search-input" id="navSearchInput"
                            placeholder="Search medicines, vitamins..." autocomplete="off" aria-autocomplete="list"
                            aria-controls="searchSuggestions">
                        <button type="button" class="search-clear-btn" id="searchClear" aria-label="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </form>

                    <!-- Search Suggestions Dropdown -->
                    <div class="search-suggestions" id="searchSuggestions" role="listbox">
                        <div class="suggestions-header">
                            <i class="fas fa-clock"></i>
                            <span>Recent Searches</span>
                        </div>
                        <div class="suggestions-list" id="suggestionsList">
                            <!-- Suggestions will be populated by JavaScript -->
                        </div>
                        <div class="suggestions-footer">
                            <button type="button" class="clear-history-btn" id="clearHistory">
                                <i class="fas fa-trash-alt"></i>
                                Clear History
                            </button>
                        </div>
                    </div>
                </div>

                {% if user.is_authenticated %}
                <!-- Cart -->
                <a href="{% url 'cart' %}" class="nav-cart" aria-label="Shopping cart">
                    <i class="fas fa-shopping-bag"></i>
                    {% if cart_count > 0 %}
                    <span class="cart-badge">{{ cart_count }}</span>
                    {% endif %}
                </a>

                <!-- User Menu -->
                <div class="dropdown">
                    <button class="user-menu-btn" type="button" aria-label="User menu">
                        <i class="fas fa-user-circle"></i>
                    </button>
                    <ul class="dropdown-menu">
                        {% block navbar_user_menu_prepend %}{% endblock %}
                        <li><a class="dropdown-item" href="{% url 'profile' %}"><i class="fas fa-user"></i> My
                                Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'orders' %}"><i class="fas fa-box"></i> My Orders</a>
                        </li>
                        {% block navbar_user_menu_append %}{% endblock %}
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="fas fa-sign-out-alt"></i>
                                Logout</a></li>
                    </ul>
                </div>
                {% else %}
                <div class="auth-group">
                    <button type="button" class="btn-login" data-bs-toggle="modal"
                        data-bs-target="#authModal">Login</button>
                    <button type="button" class="btn-signup" data-bs-toggle="modal" data-bs-target="#authModal"
                        data-mode="signup">Sign Up</button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<script>
    // Navbar functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Mobile sidebar toggle
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebar = document.getElementById('closeSidebar');

        function toggleSidebar(shouldOpen) {
            if (sidebar && sidebarOverlay) {
                const isOpen = typeof shouldOpen === 'boolean' ? shouldOpen : !sidebar.classList.contains('active');
                sidebar.classList.toggle('active', isOpen);
                sidebarOverlay.classList.toggle('active', isOpen);
                document.body.classList.toggle('sidebar-open', isOpen);
            }
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => toggleSidebar());
        }

        if (closeSidebar) {
            closeSidebar.addEventListener('click', () => toggleSidebar(false));
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => toggleSidebar(false));
        }

        // User menu dropdown
        const dropdown = document.querySelector('.nav-right .dropdown');

        if (dropdown) {
            const btn = dropdown.querySelector('.user-menu-btn');
            const menu = dropdown.querySelector('.dropdown-menu');

            if (btn && menu) {
                // Toggle dropdown on button click
                btn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    menu.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!dropdown.contains(e.target)) {
                        menu.classList.remove('show');
                    }
                });

                // Prevent dropdown from closing when clicking inside menu
                menu.addEventListener('click', function (e) {
                    e.stopPropagation();
                });
            }
        }

        // Inline expanding search with suggestions
        const searchWrapper = document.getElementById('navSearchWrapper');
        const searchToggle = document.getElementById('searchToggle');
        const searchForm = document.getElementById('navSearchForm');
        const searchInput = document.getElementById('navSearchInput');
        const searchClear = document.getElementById('searchClear');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const suggestionsList = document.getElementById('suggestionsList');
        const clearHistoryBtn = document.getElementById('clearHistory');

        // Recent searches management
        const SEARCH_HISTORY_KEY = 'quickmeds_search_history';
        const MAX_HISTORY_ITEMS = 5;

        function getSearchHistory() {
            try {
                return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY) || '[]');
            } catch {
                return [];
            }
        }

        function saveSearchHistory(query) {
            if (!query.trim()) return;
            let history = getSearchHistory();
            history = history.filter(item => item !== query);
            history.unshift(query);
            history = history.slice(0, MAX_HISTORY_ITEMS);
            localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
        }

        function clearSearchHistory() {
            localStorage.removeItem(SEARCH_HISTORY_KEY);
            renderSuggestions();
        }

        function renderSuggestions() {
            const history = getSearchHistory();
            if (history.length === 0) {
                suggestionsList.innerHTML = '';
                return;
            }

            suggestionsList.innerHTML = history.map(item => `
                <div class="suggestion-item" data-query="${item}">
                    <i class="fas fa-history"></i>
                    <span class="suggestion-text">${item}</span>
                    <button class="suggestion-remove" data-query="${item}" aria-label="Remove">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');

            // Add click handlers
            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    if (!e.target.closest('.suggestion-remove')) {
                        const query = this.dataset.query;
                        searchInput.value = query;
                        searchForm.submit();
                    }
                });
            });

            document.querySelectorAll('.suggestion-remove').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const query = this.dataset.query;
                    let history = getSearchHistory();
                    history = history.filter(item => item !== query);
                    localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(history));
                    renderSuggestions();
                });
            });
        }

        function openSearch() {
            if (searchWrapper && searchForm && searchInput) {
                searchWrapper.classList.add('active');
                searchForm.classList.add('active');
                renderSuggestions();
                if (getSearchHistory().length > 0) {
                    setTimeout(() => searchSuggestions.classList.add('active'), 100);
                }
                setTimeout(() => searchInput.focus(), 300);
            }
        }

        function closeSearch() {
            if (searchWrapper && searchForm) {
                searchWrapper.classList.remove('active');
                searchForm.classList.remove('active');
                searchSuggestions.classList.remove('active');
                if (searchInput) {
                    searchInput.value = '';
                }
            }
        }

        if (searchToggle) {
            searchToggle.addEventListener('click', function (e) {
                e.stopPropagation();
                if (searchWrapper.classList.contains('active')) {
                    closeSearch();
                } else {
                    openSearch();
                }
            });
        }

        if (searchClear) {
            searchClear.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                    searchSuggestions.classList.remove('active');
                }
            });
        }

        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', clearSearchHistory);
        }

        // Show/hide suggestions on input focus
        if (searchInput) {
            searchInput.addEventListener('focus', function () {
                if (getSearchHistory().length > 0) {
                    renderSuggestions();
                    searchSuggestions.classList.add('active');
                }
            });

            searchInput.addEventListener('input', function () {
                if (this.value.trim()) {
                    searchSuggestions.classList.remove('active');
                } else if (getSearchHistory().length > 0) {
                    searchSuggestions.classList.add('active');
                }
            });
        }

        // Save search on form submit
        if (searchForm) {
            searchForm.addEventListener('submit', function () {
                if (searchInput && searchInput.value.trim()) {
                    saveSearchHistory(searchInput.value.trim());
                }
            });
        }

        // Close search when clicking outside
        document.addEventListener('click', function (e) {
            if (searchWrapper && searchWrapper.classList.contains('active')) {
                if (!searchWrapper.contains(e.target)) {
                    closeSearch();
                }
            }
        });

        // Prevent closing when clicking inside search form or suggestions
        if (searchForm) {
            searchForm.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        if (searchSuggestions) {
            searchSuggestions.addEventListener('click', function (e) {
                e.stopPropagation();
            });
        }

        // Close search on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (searchWrapper && searchWrapper.classList.contains('active')) {
                    closeSearch();
                }
                if (sidebar && sidebar.classList.contains('active')) {
                    toggleSidebar(false);
                }
            }
        });

        // Show/hide clear button based on input
        if (searchInput && searchClear) {
            searchInput.addEventListener('input', function () {
                if (this.value.trim()) {
                    searchClear.style.opacity = '1';
                    searchClear.style.pointerEvents = 'auto';
                } else {
                    searchClear.style.opacity = '0';
                    searchClear.style.pointerEvents = 'none';
                }
            });
        }
    });
</script>