{% extends 'base.html' %}
{% load static %}

{% block title %}Login - QuickMeds{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/login.css' %}">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
/* Override base template styles for login page */
body {
	padding: 0;
	margin: 0;
}
.main-content {
	padding: 0;
	margin: 0;
	width: 100%;
}
</style>
{% endblock %}

{% block header %}
<!-- No navbar on login page -->
{% endblock %}

{% block footer %}
<!-- No footer on login page -->
{% endblock %}

{% block content_wrapper %}
<div class="login-wrapper">
	<div class="container" id="container">
		<div class="form-container sign-up-container">
			<form id="signupForm" onsubmit="return handleSignup(event)">
				{% csrf_token %}
				<h1>Create Account</h1>
				<span>Sign up to get started</span>
				<div id="registration-step-1">
					<input type="text" name="name" placeholder="Full Name" required pattern="[A-Za-z\s]+" title="Please enter only letters and spaces" autocomplete="name" />
					<input type="email" name="email" placeholder="Email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address" autocomplete="email" />
					<div class="password-wrapper">
						<input type="password" name="password" id="password" placeholder="Password" required minlength="8" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters" autocomplete="new-password" />
						<button type="button" class="password-toggle" onclick="togglePassword('password')">
							<i class="fas fa-eye" id="password-eye"></i>
						</button>
					</div>
					<div class="password-wrapper">
						<input type="password" name="confirm_password" id="confirm_password" placeholder="Confirm Password" required autocomplete="new-password" />
						<button type="button" class="password-toggle" onclick="togglePassword('confirm_password')">
							<i class="fas fa-eye" id="confirm_password-eye"></i>
						</button>
					</div>
					<div id="password-match-message" class="password-message"></div>
					<button type="submit" class="sign-button">SIGN UP</button>
				</div>
				<div id="registration-step-2" style="display: none;">
					<p>Please enter the OTP sent to your email</p>
					<div class="otp-input-container">
						<input type="text" maxlength="1" class="otp-input" />
						<input type="text" maxlength="1" class="otp-input" />
						<input type="text" maxlength="1" class="otp-input" />
						<input type="text" maxlength="1" class="otp-input" />
					</div>
					<button type="button" class="sign-button" onclick="verifyOTP()">Verify OTP</button>
					<button type="button" class="sign-button resend" onclick="resendOTP()">Resend OTP</button>
				</div>
			</form>
		</div>
		<div class="form-container sign-in-container">
			<form id="loginForm" onsubmit="return handleLogin(event)">
				{% csrf_token %}
				<h1>Welcome Back</h1>
				<span>Sign in to your account</span>
				<input type="email" name="email" placeholder="Email" required />
				<div class="password-wrapper">
					<input type="password" name="password" id="login_password" placeholder="Password" required />
					<button type="button" class="password-toggle" onclick="togglePassword('login_password')">
						<i class="fas fa-eye" id="login_password-eye"></i>
					</button>
				</div>
				<a href="#" class="forgot-password">Forgot your password?</a>
				<button type="submit" class="sign-button">SIGN IN</button>
				<div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
					<a href="{% url 'admin_login' %}" class="admin-link" style="color: #666; font-size: 12px; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 5px;">
						<i class="fas fa-user-shield"></i>
						<span>Admin Panel</span>
					</a>
				</div>
			</form>
		</div>
		<div class="overlay-container">
			<div class="overlay">
				<div class="overlay-panel overlay-left">
					<h1>Welcome Back!</h1>
					<p>Sign in to access your account and continue your healthcare journey</p>
					<button class="ghost" id="signIn">SIGN IN</button>
				</div>
				<div class="overlay-panel overlay-right">
					<h1>Hello, Friend!</h1>
					<p>Create an account and discover a better way to manage your health</p>
					<button class="ghost" id="signUp">SIGN UP</button>
				</div>
			</div>
		</div>
	</div>

	{% if messages %}
	<div class="messages">
		{% for message in messages %}
		<div class="alert alert-{{ message.tags }}">
			{{ message }}
		</div>
		{% endfor %}
	</div>
	{% endif %}
</div>
{% endblock content_wrapper %}

{% block extra_js %}
<script src="{% static 'js/login.js' %}"></script>
<script>
let registrationEmail = '';

async function handleSignup(event) {
	event.preventDefault();
	const form = event.target;
	const formData = new FormData(form);
	
	if (formData.get('password') !== formData.get('confirm_password')) {
		alert('Passwords do not match!');
		return false;
	}
	
	registrationEmail = formData.get('email');
	
	try {
		const response = await fetch('{% url "login" %}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
			},
			body: JSON.stringify({
				action: 'register',
				name: formData.get('name'),
				email: formData.get('email'),
				password: formData.get('password')
			})
		});
		
		const data = await response.json();
		if (data.success) {
			document.getElementById('registration-step-1').style.display = 'none';
			document.getElementById('registration-step-2').style.display = 'block';
		} else {
			alert(data.message);
		}
	} catch (error) {
		alert('Error during registration. Please try again.');
	}
	
	return false;
}

async function resendOTP() {
	if (!registrationEmail) {
		alert('Please complete registration form first');
		return;
	}
	
	try {
		const response = await fetch('{% url "login" %}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
			},
			body: JSON.stringify({
				action: 'register',
				email: registrationEmail,
				name: document.querySelector('input[name="name"]').value,
				password: document.querySelector('input[name="password"]').value
			})
		});
		
		const data = await response.json();
		if (data.success) {
			alert('OTP resent successfully! Please check your email.');
			// Clear OTP inputs
			document.querySelectorAll('.otp-input').forEach(input => input.value = '');
			document.querySelectorAll('.otp-input')[0].focus();
		} else {
			alert(data.message);
		}
	} catch (error) {
		alert('Error resending OTP. Please try again.');
	}
}

async function verifyOTP() {
	const otpInputs = document.querySelectorAll('.otp-input');
	const otp = Array.from(otpInputs).map(input => input.value).join('');
	
	if (otp.length !== 4) {
		alert('Please enter complete OTP');
		return;
	}
	
	try {
		const response = await fetch('{% url "login" %}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
			},
			body: JSON.stringify({
				action: 'verify_otp',
				email: registrationEmail,
				otp: otp
			})
		});
		
		const data = await response.json();
		if (data.success) {
			alert(data.message);
			window.location.href = data.redirect_url;
		} else {
			alert(data.message);
		}
	} catch (error) {
		alert('Error during OTP verification. Please try again.');
	}
}

async function handleLogin(event) {
	event.preventDefault();
	const form = event.target;
	const formData = new FormData(form);
	
	try {
		const response = await fetch('{% url "login" %}', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
			},
			body: JSON.stringify({
				action: 'login',
				email: formData.get('email'),
				password: document.getElementById('login_password').value || formData.get('password')
			})
		});
		
		const data = await response.json();
		if (data.success) {
			window.location.href = data.redirect_url;
		} else {
			alert(data.message);
		}
	} catch (error) {
		alert('Error during login. Please try again.');
	}
	
	return false;
}

// OTP input handling
document.querySelectorAll('.otp-input').forEach((input, index) => {
	input.addEventListener('input', function(e) {
		if (this.value.length === 1) {
			if (index < document.querySelectorAll('.otp-input').length - 1) {
				document.querySelectorAll('.otp-input')[index + 1].focus();
			}
		}
	});

	input.addEventListener('keydown', function(e) {
		if (e.key === 'Backspace' && !this.value && index > 0) {
			document.querySelectorAll('.otp-input')[index - 1].focus();
		}
	});
});

// Password match validation
document.getElementById('confirm_password').addEventListener('input', function() {
	const password = document.getElementById('password').value;
	const confirmPassword = this.value;
	const message = document.getElementById('password-match-message');
	
	if (password === confirmPassword) {
		message.textContent = 'Passwords match!';
		message.style.color = 'green';
	} else {
		message.textContent = 'Passwords do not match!';
		message.style.color = 'red';
	}
});

// Password visibility toggle function
function togglePassword(inputId) {
	const passwordInput = document.getElementById(inputId);
	const eyeIcon = document.getElementById(inputId + '-eye');
	
	if (passwordInput.type === 'password') {
		passwordInput.type = 'text';
		eyeIcon.classList.remove('fa-eye');
		eyeIcon.classList.add('fa-eye-slash');
	} else {
		passwordInput.type = 'password';
		eyeIcon.classList.remove('fa-eye-slash');
		eyeIcon.classList.add('fa-eye');
	}
}
</script>
{% endblock %}
