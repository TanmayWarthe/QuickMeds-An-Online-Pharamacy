{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - QuickMeds{% endblock %}

{% block navbar_center %}
<!-- Simplified navigation for product detail page -->
<nav class="main-nav" aria-label="Main navigation">
    <a href="{% url 'product' %}" class="nav-link">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Products</span>
    </a>
</nav>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product-detail.css' %}">
<style>
    /* Cleaner navbar for product detail */
    .modern-navbar {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #e0e0e0;
    }
    
    .nav-center {
        flex: 1;
        display: flex;
        justify-content: center;
    }
    
    .main-nav .nav-link {
        padding: 10px 20px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .main-nav .nav-link:hover {
        background: #f5f5f5;
        transform: translateX(-2px);
    }
    
    .main-nav .nav-link i {
        margin-right: 6px;
    }
    
    /* Hide search button on product detail */
    .nav-search-btn {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="product-detail-container">
    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="fas fa-home"></i> Home</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product' %}">Products</a></li>
            <li class="breadcrumb-item"><a href="{% url 'product' %}">{{ product.category.name }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
        </ol>
    </nav>

    <div class="product-detail-grid">
        <!-- Product Image Section -->
        <div class="product-image-section">
            <div class="image-container">
                <div class="main-image-wrapper">
                    {% if product.image %}
                        <img id="mainImage" src="{{ product.image.url }}" alt="{{ product.name }}" class="main-product-image">
                    {% else %}
                        <img id="mainImage" src="{% static 'img/medicines-icon.png' %}" alt="{{ product.name }}" class="main-product-image">
                    {% endif %}
                    
                    <!-- Image Badges -->
                    <div class="image-badges">
                        {% if product.discount_percentage > 0 %}
                            <span class="badge badge-discount">-{{ product.discount_percentage|floatformat:0 }}%</span>
                        {% endif %}
                        {% if product.stock < 10 and product.stock > 0 %}
                            <span class="badge badge-low-stock">Low Stock</span>
                        {% elif product.stock == 0 %}
                            <span class="badge badge-out-of-stock">Out of Stock</span>
                        {% endif %}
                        {% if is_expiring_soon %}
                            <span class="badge badge-expiring"><i class="fas fa-clock"></i> Expiring Soon</span>
                        {% endif %}
                    </div>

                    <!-- Zoom Button -->
                    <button class="zoom-btn" onclick="toggleImageZoom()" title="Zoom Image">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>

                <!-- Thumbnail Gallery (if multiple images exist) -->
                <div class="thumbnail-gallery" id="thumbnailGallery" style="display: none;">
                    <!-- Thumbnails will be added via JavaScript if needed -->
                </div>
            </div>
        </div>

        <!-- Product Information Section -->
        <div class="product-info-section">
            <div class="product-header">
                <h1 class="product-title">{{ product.name }}</h1>
                {% if product.code %}
                    <p class="product-code">Product Code: <span>{{ product.code }}</span></p>
                {% endif %}
            </div>

            <!-- Rating and Reviews (placeholder for future implementation) -->
            <div class="product-rating">
                <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                </div>
                <span class="rating-text">4.5 (128 reviews)</span>
            </div>

            <!-- Price Section -->
            <div class="price-section">
                <div class="current-price">₹{{ product.price }}</div>
                {% if product.original_price and product.original_price > product.price %}
                    <div class="price-details">
                        <span class="original-price">₹{{ product.original_price }}</span>
                    </div>
                {% endif %}
            </div>

            <!-- Stock and Expiry Information -->
            <div class="stock-info">
                {% if product.stock > 0 %}
                    <div class="stock-status in-stock">
                        <i class="fas fa-check-circle"></i>
                        <span>In Stock ({{ product.stock }} available)</span>
                    </div>
                {% else %}
                    <div class="stock-status out-of-stock">
                        <i class="fas fa-times-circle"></i>
                        <span>Out of Stock</span>
                    </div>
                {% endif %}
                
                {% if product.expiry_date %}
                    <div class="expiry-info {% if is_expiring_soon %}expiring-soon{% endif %}">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Expires: {{ product.expiry_date|date:"M d, Y" }}</span>
                        {% if product.days_until_expiry %}
                            <span class="days-remaining">({{ product.days_until_expiry }} days)</span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>

            <!-- Quantity Selector -->
            <div class="quantity-section">
                <label for="quantity" class="quantity-label">Quantity:</label>
                <div class="quantity-controls">
                    <button class="qty-btn" onclick="decrementQuantity()" aria-label="Decrease quantity">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="quantity" class="quantity-input" value="1" min="1" max="{{ product.stock }}" readonly>
                    <button class="qty-btn" onclick="incrementQuantity()" aria-label="Increase quantity">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <span class="max-qty-text">Max: {{ product.stock }}</span>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                {% if product.stock > 0 %}
                    <button class="btn btn-add-to-cart" onclick="addToCartFromDetail()">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Add to Cart</span>
                    </button>
                    <button class="btn btn-buy-now" onclick="buyNow()">
                        <i class="fas fa-bolt"></i>
                        <span>Buy Now</span>
                    </button>
                {% else %}
                    <button class="btn btn-notify" onclick="notifyWhenAvailable()">
                        <i class="fas fa-bell"></i>
                        <span>Notify When Available</span>
                    </button>
                {% endif %}
                <button class="btn btn-wishlist" onclick="toggleWishlist()" title="Add to Wishlist">
                    <i class="far fa-heart"></i>
                </button>
            </div>

            <!-- Key Features -->
            <div class="key-features">
                <h3 class="features-title">Key Features</h3>
                <ul class="features-list">
                    <li><i class="fas fa-check"></i> Genuine & Authentic Product</li>
                    <li><i class="fas fa-check"></i> Quality Assured</li>
                    <li><i class="fas fa-check"></i> Fast & Secure Delivery</li>
                    <li><i class="fas fa-check"></i> Easy Returns & Refunds</li>
                </ul>
            </div>

            <!-- Additional Info Pills -->
            <div class="info-pills">
                <span class="info-pill"><i class="fas fa-truck"></i> Free Delivery on orders above ₹500</span>
                <span class="info-pill"><i class="fas fa-undo"></i> 7 Days Return Policy</span>
                <span class="info-pill"><i class="fas fa-shield-alt"></i> 100% Secure Payments</span>
            </div>
        </div>
    </div>

    <!-- Product Details Tabs -->
    <div class="product-tabs-section">
        <div class="tabs-header">
            <button class="tab-btn active" onclick="switchTab('description')">
                <i class="fas fa-info-circle"></i> Description
            </button>
            <button class="tab-btn" onclick="switchTab('details')">
                <i class="fas fa-list"></i> Details
            </button>
            <button class="tab-btn" onclick="switchTab('reviews')">
                <i class="fas fa-star"></i> Reviews (128)
            </button>
            <button class="tab-btn" onclick="switchTab('shipping')">
                <i class="fas fa-shipping-fast"></i> Shipping
            </button>
        </div>

        <div class="tabs-content">
            <!-- Description Tab -->
            <div id="description" class="tab-content active">
                <h3>Product Description</h3>
                {% if product.description %}
                    <p>{{ product.description|linebreaks }}</p>
                {% else %}
                    <p>{{ product.name }} is a high-quality pharmaceutical product designed to meet your healthcare needs. This product is manufactured under strict quality control standards to ensure safety and efficacy.</p>
                    <p>Always consult with a healthcare professional before using this product. Follow the dosage instructions carefully and store as directed.</p>
                {% endif %}
                
                <div class="usage-instructions">
                    <h4><i class="fas fa-pills"></i> Usage Instructions</h4>
                    <p>Take as directed by your physician or as indicated on the product label. Do not exceed the recommended dosage.</p>
                </div>

                <div class="precautions">
                    <h4><i class="fas fa-exclamation-triangle"></i> Precautions</h4>
                    <ul>
                        <li>Keep out of reach of children</li>
                        <li>Store in a cool, dry place away from direct sunlight</li>
                        <li>Check expiry date before use</li>
                        <li>Consult a doctor if symptoms persist</li>
                    </ul>
                </div>
            </div>

            <!-- Details Tab -->
            <div id="details" class="tab-content">
                <h3>Product Details</h3>
                <table class="details-table">
                    <tr>
                        <td class="label">Product Name</td>
                        <td>{{ product.name }}</td>
                    </tr>
                    {% if product.code %}
                    <tr>
                        <td class="label">Product Code</td>
                        <td>{{ product.code }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="label">Category</td>
                        <td>{{ product.category.name }}</td>
                    </tr>
                    <tr>
                        <td class="label">Price</td>
                        <td>₹{{ product.price }}</td>
                    </tr>
                    {% if product.original_price %}
                    <tr>
                        <td class="label">Original Price</td>
                        <td>₹{{ product.original_price }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="label">Stock Status</td>
                        <td>
                            {% if product.stock > 0 %}
                                <span class="badge-status available">In Stock</span>
                            {% else %}
                                <span class="badge-status unavailable">Out of Stock</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if product.expiry_date %}
                    <tr>
                        <td class="label">Expiry Date</td>
                        <td>{{ product.expiry_date|date:"F d, Y" }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>

            <!-- Reviews Tab -->
            <div id="reviews" class="tab-content">
                <h3>Customer Reviews</h3>
                <div class="reviews-summary">
                    <div class="overall-rating">
                        <div class="rating-number">4.5</div>
                        <div class="rating-stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star-half-alt"></i>
                        </div>
                        <div class="total-reviews">Based on 128 reviews</div>
                    </div>
                    <div class="rating-breakdown">
                        <div class="rating-bar">
                            <span>5 <i class="fas fa-star"></i></span>
                            <div class="bar"><div class="fill" style="width: 75%"></div></div>
                            <span>96</span>
                        </div>
                        <div class="rating-bar">
                            <span>4 <i class="fas fa-star"></i></span>
                            <div class="bar"><div class="fill" style="width: 15%"></div></div>
                            <span>19</span>
                        </div>
                        <div class="rating-bar">
                            <span>3 <i class="fas fa-star"></i></span>
                            <div class="bar"><div class="fill" style="width: 6%"></div></div>
                            <span>8</span>
                        </div>
                        <div class="rating-bar">
                            <span>2 <i class="fas fa-star"></i></span>
                            <div class="bar"><div class="fill" style="width: 3%"></div></div>
                            <span>4</span>
                        </div>
                        <div class="rating-bar">
                            <span>1 <i class="fas fa-star"></i></span>
                            <div class="bar"><div class="fill" style="width: 1%"></div></div>
                            <span>1</span>
                        </div>
                    </div>
                </div>

                <div class="reviews-list">
                    <!-- Sample Review -->
                    <div class="review-card">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-avatar">A</div>
                                <div>
                                    <div class="reviewer-name">Anonymous Customer</div>
                                    <div class="review-date">3 days ago</div>
                                </div>
                            </div>
                            <div class="review-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <div class="review-content">
                            <p>Great product! Exactly as described. Fast delivery and well packaged. Highly recommended.</p>
                        </div>
                        <div class="review-helpful">
                            <button class="helpful-btn"><i class="far fa-thumbs-up"></i> Helpful (12)</button>
                        </div>
                    </div>
                    
                    <!-- Add more reviews button -->
                    <button class="btn-load-more">Load More Reviews</button>
                </div>
            </div>

            <!-- Shipping Tab -->
            <div id="shipping" class="tab-content">
                <h3>Shipping Information</h3>
                <div class="shipping-info">
                    <div class="shipping-option">
                        <div class="option-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="option-details">
                            <h4>Standard Delivery</h4>
                            <p>Delivery within 5-7 business days</p>
                            <p class="price">Free for orders above ₹500</p>
                        </div>
                    </div>
                    <div class="shipping-option">
                        <div class="option-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="option-details">
                            <h4>Express Delivery</h4>
                            <p>Delivery within 2-3 business days</p>
                            <p class="price">₹99</p>
                        </div>
                    </div>
                    <div class="shipping-option">
                        <div class="option-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="option-details">
                            <h4>Same Day Delivery</h4>
                            <p>Order before 2 PM for same-day delivery</p>
                            <p class="price">₹199 (Available in select cities)</p>
                        </div>
                    </div>
                </div>

                <div class="return-policy">
                    <h4><i class="fas fa-undo"></i> Return Policy</h4>
                    <p>We offer a 7-day return policy for unopened items in their original packaging. Medicines and healthcare products must be returned unused and sealed.</p>
                    <ul>
                        <li>Return window: 7 days from delivery</li>
                        <li>Condition: Unopened and unused</li>
                        <li>Refund: Within 7-10 business days</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Related Products Section -->
    <div class="related-products-section">
        <h2 class="section-title">You May Also Like</h2>
        <div class="related-products-grid" id="relatedProducts">
            <!-- Related products will be loaded dynamically -->
        </div>
    </div>
</div>

<!-- Image Zoom Modal -->
<div id="imageZoomModal" class="zoom-modal" onclick="closeImageZoom()">
    <span class="zoom-close">&times;</span>
    <img class="zoom-modal-content" id="zoomedImage">
</div>

<!-- Notification Toast -->
<div id="notification" class="notification">
    <i class="notification-icon"></i>
    <span id="notification-message"></span>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/product-detail.js' %}"></script>
<script>
    // Pass Django context to JavaScript
    const PRODUCT_ID = {{ product.id }};
    const PRODUCT_STOCK = {{ product.stock }};
    const PRODUCT_CATEGORY_ID = {{ product.category.id }};
</script>
{% endblock %}