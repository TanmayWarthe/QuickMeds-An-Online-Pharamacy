{% extends 'base.html' %}
{% load cloudinary %}
{% load static %}
{% load cloudinary %}

{% block title %}Products - QuickMeds{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/product-catalog.css' %}">
<link rel="stylesheet" href="{% static 'css/product-catalog-responsive.css' %}">
{% endblock %}

{% block content %}
<div class="catalog-container">
    <!-- Page Header -->
    <div class="catalog-header">
        <div class="medical-particles">
            <i class="fas fa-pills particle p-1"></i>
            <i class="fas fa-capsules particle p-2"></i>
            <i class="fas fa-heartbeat particle p-3"></i>
            <i class="fas fa-stethoscope particle p-4"></i>
            <i class="fas fa-syringe particle p-5"></i>
            <i class="fas fa-prescription-bottle particle p-6"></i>
            <i class="fas fa-first-aid particle p-7"></i>
            <i class="fas fa-tablets particle p-8"></i>
        </div>
        <div class="header-content">
            <h1 class="tagline">
                <link
                    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Playfair+Display:wght@700&family=Poppins:wght@600&display=swap"
                    rel="stylesheet">
                Your Health, Our Priority
            </h1>
        </div>
    </div>



    <!-- Category Pills -->
    <div class="category-section">
        <div class="category-header">
            <h2 class="category-title">
                <i class="fas fa-layer-group"></i>
                Shop by Category
            </h2>
            <div class="carousel-controls">
                <button class="carousel-btn prev-btn" onclick="scrollCategories('left')">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="carousel-btn next-btn" onclick="scrollCategories('right')">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="category-carousel-wrapper">
            <div class="category-carousel" id="categoryCarousel">
                <!-- All Products Card -->
                <div class="category-card {% if not request.GET.category %}active{% endif %}"
                    onclick="filterByCategory('')">
                    <div class="category-card-inner all-category">
                        <div class="category-image-wrapper">
                            <div class="category-icon-fallback">
                                <i class="fas fa-th-large"></i>
                            </div>
                        </div>
                        <h3 class="category-card-title">All Products</h3>
                        <p class="category-card-desc">Browse Everything</p>
                        <div class="category-badge">{{ products.count }}</div>
                    </div>
                </div>
                
                {% for category in categories %}
                <div class="category-card {% if request.GET.category == category.name %}active{% endif %}"
                    onclick="filterByCategory('{{ category.name }}')">
                    <div class="category-card-inner">
                        <div class="category-image-wrapper">
                            {% if category.image %}
                                {% cloudinary category.image.public_id width=80 height=80 crop="fit" class="category-image" %}
                            {% else %}
                                <div class="category-icon-fallback">
                                    {% if 'Medicine' in category.name or 'Drug' in category.name or 'Tablet' in category.name %}
                                    <i class="fas fa-pills"></i>
                                    {% elif 'Pain' in category.name or 'Relief' in category.name %}
                                    <i class="fas fa-head-side-cough"></i>
                                    {% elif 'Vitamin' in category.name or 'Supplement' in category.name %}
                                    <i class="fas fa-leaf"></i>
                                    {% elif 'First Aid' in category.name or 'Band' in category.name %}
                                    <i class="fas fa-first-aid"></i>
                                    {% elif 'Baby' in category.name or 'Child' in category.name %}
                                    <i class="fas fa-baby"></i>
                                    {% elif 'Personal Care' in category.name or 'Hygiene' in category.name %}
                                    <i class="fas fa-spray-can"></i>
                                    {% elif 'Skin' in category.name or 'Beauty' in category.name %}
                                    <i class="fas fa-heart"></i>
                                    {% elif 'Diabetic' in category.name or 'Diabetes' in category.name %}
                                    <i class="fas fa-syringe"></i>
                                    {% elif 'Heart' in category.name or 'Cardiac' in category.name %}
                                    <i class="fas fa-heartbeat"></i>
                                    {% elif 'Eye' in category.name or 'Vision' in category.name %}
                                    <i class="fas fa-eye"></i>
                                    {% elif 'Dental' in category.name or 'Oral' in category.name %}
                                    <i class="fas fa-tooth"></i>
                                    {% elif 'Wellness' in category.name or 'Health' in category.name %}
                                    <i class="fas fa-dumbbell"></i>
                                    {% else %}
                                    <i class="fas fa-capsules"></i>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        <h3 class="category-card-title">{{ category.name }}</h3>
                        <p class="category-card-desc">{{ category.products.count }} Products</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid" id="productsGrid">
        {% for product in products %}
        {% include 'partials/product_card.html' with product=product %}
        {% empty %}
        <div class="empty-state">
            <i class="fas fa-box-open"></i>
            <h3>No Products Found</h3>
            <p>Try adjusting your filters or search terms</p>
        </div>
        {% endfor %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Filter by category
    function filterByCategory(category) {
        const url = new URL(window.location.href);
        if (category) {
            url.searchParams.set('category', category);
        } else {
            url.searchParams.delete('category');
        }
        window.location.href = url.toString();
    }

    // Search functionality
    function handleSearch(event) {
        const searchInput = event.target;
        const clearBtn = document.querySelector('.search-clear-btn');

        // Show/hide clear button
        if (searchInput.value.trim()) {
            clearBtn.style.display = 'flex';
        } else {
            clearBtn.style.display = 'none';
        }

        // Search on Enter key
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    // Perform search
    function performSearch() {
        const searchValue = document.getElementById('searchInput').value.trim();
        const url = new URL(window.location.href);
        if (searchValue) {
            url.searchParams.set('search', searchValue);
        } else {
            url.searchParams.delete('search');
        }
        window.location.href = url.toString();
    }

    // Clear search
    function clearSearch() {
        const searchInput = document.getElementById('searchInput');
        searchInput.value = '';
        searchInput.focus();
        document.querySelector('.search-clear-btn').style.display = 'none';

        // Clear search from URL
        const url = new URL(window.location.href);
        url.searchParams.delete('search');
        window.location.href = url.toString();
    }

    // Open product detail in same page
    function openProductDetail(productId, event) {
        // Don't open if clicking on action buttons or within product-actions div
        if (event && (event.target.closest('.product-actions') || event.target.closest('.btn-add-cart') || event.target.closest('.btn-quick-view') || event.target.closest('.btn-wishlist-quick') || event.target.closest('.btn-notify'))) {
            event.stopPropagation();
            return;
        }
        // Open in same page
        window.location.href = `/product/${productId}/`;
    }

    // Add to cart quick
    function addToCartQuick(event, productId) {
        event.stopPropagation();
        event.preventDefault();

        const button = event.currentTarget;
        if (button.disabled) return;
        button.disabled = true;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        fetch(`/add-to-cart/${productId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                'product_id': productId,
                'quantity': 1
            }),
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                if (response.status === 403) {
                    setTimeout(() => window.location.href = '/login/', 2000);
                    throw new Error('Not authenticated');
                }
                throw new Error('Failed to add to cart');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                updateCartCount();
                button.innerHTML = '<i class="fas fa-check"></i> Added';
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }, 1500);
            } else {
                throw new Error(data.message || 'Failed to add to cart');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }

    // Notify me
    function notifyMe(event, productId) {
        event.stopPropagation();
        // Notify functionality - placeholder
    }

    // Toggle wishlist quick
    function toggleWishlistQuick(event, productId) {
        event.stopPropagation();
        event.preventDefault();

        const button = event.currentTarget;
        const icon = button.querySelector('i');

        // Toggle active state
        button.classList.toggle('active');

        if (button.classList.contains('active')) {
            icon.classList.remove('far');
            icon.classList.add('fas');
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far');
        }
    }

    // Update cart count
    function updateCartCount() {
        fetch('/get-cart-count/', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cartBadge = document.querySelector('.cart-badge');
                    if (cartBadge) {
                        if (data.cart_count > 0) {
                            cartBadge.textContent = data.cart_count;
                            cartBadge.style.display = 'flex';
                        } else {
                            cartBadge.style.display = 'none';
                        }
                    }
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Category Carousel Functions
    function scrollCategories(direction) {
        const carousel = document.getElementById('categoryCarousel');
        const scrollAmount = 300; // Scroll by ~1.5 cards
        
        if (direction === 'left') {
            carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        } else {
            carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        }
        
        updateCarouselButtons();
    }

    function updateCarouselButtons() {
        const carousel = document.getElementById('categoryCarousel');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');
        
        if (!carousel || !prevBtn || !nextBtn) return;
        
        // Check if at start
        if (carousel.scrollLeft <= 10) {
            prevBtn.style.opacity = '0.3';
            prevBtn.style.cursor = 'not-allowed';
        } else {
            prevBtn.style.opacity = '1';
            prevBtn.style.cursor = 'pointer';
        }
        
        // Check if at end
        if (carousel.scrollLeft >= carousel.scrollWidth - carousel.clientWidth - 10) {
            nextBtn.style.opacity = '0.3';
            nextBtn.style.cursor = 'not-allowed';
        } else {
            nextBtn.style.opacity = '1';
            nextBtn.style.cursor = 'pointer';
        }
    }

    // Initialize carousel buttons on load
    document.addEventListener('DOMContentLoaded', function() {
        updateCarouselButtons();
        
        const carousel = document.getElementById('categoryCarousel');
        if (carousel) {
            carousel.addEventListener('scroll', updateCarouselButtons);
        }
    });
        return cookieValue;
    }

    // Update product count on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateCartCount();

        // Show clear button if search value exists
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.querySelector('.search-clear-btn');
        if (searchInput.value.trim()) {
            clearBtn.style.display = 'flex';
        }
    });
</script>
{% endblock %}